---
title: ä»ä½¿ç”¨åœºæ™¯äº†è§£proxy
tag: proxy,markdown
cover: ./2021-2-23-proxy.assets/20210223114632.png
base64: f0df3d
author: artiely
date: Mon, 22 Feb 2021 16:00:00 GMT
data: 2021-2-23
summary: ä»ä½¿ç”¨åœºæ™¯äº†è§£ proxyåŠ ç²—å‰é¢è®²è¿‡ä¸€ç¯‡ï¼Œç°åœ¨å°±å¸¦å¤§å®¶äº†è§£ä¸€ä¸‹proxyçš„å®é™…åº”ç”¨ï¼Œæ›´æ·±å…¥çš„äº†è§£proxyçš„å¦™ç”¨åŠä»·å€¼å§ï¼ å‘¼åº”ä¸Šäº†~ç”±ä¿­å…¥å¥¢### è·Ÿè¸ªå±æ€§è®¿é—®ï¼ˆgetï¼Œsetï¼‰å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªå‡½æ•°tracePropAccess(obj, propKeys)ï¼Œè¯¥å‡½æ•° obj åœ¨ propKeys è®¾ç½®æˆ–è·å–çš„å±æ€§ï¼ˆå…¶é”®åœ¨ Array ä¸­ï¼‰æ—¶è¿›è¡Œè®°å½•ã€‚ ...
description: ä»ä½¿ç”¨åœºæ™¯äº†è§£ proxyåŠ ç²—å‰é¢è®²è¿‡ä¸€ç¯‡ï¼Œç°åœ¨å°±å¸¦å¤§å®¶äº†è§£ä¸€ä¸‹proxyçš„å®é™…åº”ç”¨ï¼Œæ›´æ·±å…¥çš„äº†è§£proxyçš„å¦™ç”¨åŠä»·å€¼å§ï¼ å‘¼åº”ä¸Šäº†~ç”±ä¿­å…¥å¥¢### è·Ÿè¸ªå±æ€§è®¿é—®ï¼ˆgetï¼Œsetï¼‰å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªå‡½æ•°tracePropAccess(obj, propKeys)ï¼Œè¯¥å‡½æ•° obj åœ¨ propKeys è®¾ç½®æˆ–è·å–çš„å±æ€§ï¼ˆå…¶é”®åœ¨ Array ä¸­ï¼‰æ—¶è¿›è¡Œè®°å½•ã€‚ ...
primary: ebdb5b
secondary: 1424a4
readTime: 13 min read
words: 2564
calendar: è¾›ä¸‘,ç‰›,åºšå¯…,å£¬å¯…,æ­£æœˆ,åäºŒ,æ˜ŸæœŸäºŒ
---

# ä»ä½¿ç”¨åœºæ™¯äº†è§£ proxy

**åŠ ç²—**
å‰é¢è®²è¿‡ä¸€ç¯‡[proxy çš„æ·±å…¥ç†è§£](/post/2020/2020-9-2-proxy)ï¼Œç°åœ¨å°±å¸¦å¤§å®¶äº†è§£ä¸€ä¸‹`proxy`çš„å®é™…åº”ç”¨ï¼Œæ›´æ·±å…¥çš„äº†è§£`proxy`çš„å¦™ç”¨åŠä»·å€¼å§ï¼ å‘¼åº”ä¸Šäº†~

ç”±ä¿­å…¥å¥¢

### è·Ÿè¸ªå±æ€§è®¿é—®ï¼ˆgetï¼Œsetï¼‰

å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªå‡½æ•°`tracePropAccess(obj, propKeys`)ï¼Œè¯¥å‡½æ•° obj åœ¨ propKeys è®¾ç½®æˆ–è·å–çš„å±æ€§ï¼ˆå…¶é”®åœ¨ Array ä¸­ï¼‰æ—¶è¿›è¡Œè®°å½•ã€‚åœ¨ä»¥ä¸‹ä»£ç ä¸­ï¼Œæˆ‘ä»¬å°†è¯¥å‡½æ•°åº”ç”¨äºç±»çš„å®ä¾‹ Pointï¼š

```js ${3-4}
class Point {
  constructor(x, y) {
    this.x = x;
    this.y = y;
  }
  toString() {
    return `Point(${this.x}, ${this.y})`;
  }
}
const p = new Point(5, 7);
// è¿½è¸ªå±æ€§ `x` and `y`
p = tracePropAccess(p, ["x", "y"]);
```

æˆ‘ä»¬å¸Œæœ›è®¾ç½®æˆ–è·å–å±æ€§æ—¶å¾—åˆ°ä»¥ä¸‹æ•ˆæœ

```js
> p.x
GET x
5
> p.x = 21
SET x=21
21
```

åŸºäº`proxy`çš„ç®€å•å®ç°

```js
function tracePropAccess(obj, propKeys) {
  const propKeySet = new Set(propKeys);
  return new Proxy(obj, {
    get(target, propKey, receiver) {
      if (propKeySet.has(propKey)) {
        console.log("GET " + propKey);
      }
      return Reflect.get(target, propKey, receiver);
    },
    set(target, propKey, value, receiver) {
      if (propKeySet.has(propKey)) {
        console.log("SET " + propKey + "=" + value);
      }
      return Reflect.set(target, propKey, value, receiver);
    },
  });
}
```
åŸºäºä»¥ä¸Šæˆ‘ä»¬å¯ä»¥å®ç°æ—¥å¿—æ‰“å°ï¼Œæ•°æ®ç»Ÿè®¡ç­‰

### è·å–æœªçŸ¥å±æ€§çš„è­¦å‘Š

åœ¨è®¿é—®å±æ€§æ—¶ï¼ŒJavaScript éå¸¸å®½å®¹ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨å°è¯•è¯»å–å±æ€§å¹¶æ‹¼å†™é”™è¯¯çš„åç§°ï¼Œåˆ™ä¸ä¼šå¾—åˆ°å¼‚å¸¸ï¼Œè€Œä¼šå¾—åˆ°ç»“æœ`undefined`ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»£ç†è·å–ä¾‹å¤–ã€‚å…¶å·¥ä½œåŸç†å¦‚ä¸‹ã€‚æˆ‘ä»¬ä½¿ä»£ç†æˆä¸ºå¯¹è±¡çš„åŸå‹ã€‚

å¦‚æœåœ¨å¯¹è±¡ä¸­æ‰¾ä¸åˆ°å±æ€§ï¼Œget åˆ™ä¼šè§¦å‘ã€‚å¦‚æœè¯¥å±æ€§ç”šè‡³åœ¨ä»£ç†ä¹‹åçš„åŸå‹é“¾ä¸­ä¸å­˜åœ¨ï¼Œåˆ™ä¼šå¼•å‘å¼‚å¸¸ã€‚å¦åˆ™ï¼Œæˆ‘ä»¬è¿”å›ç»§æ‰¿å±æ€§çš„å€¼ã€‚æˆ‘ä»¬å°†æ“ä½œè½¬å‘åˆ°ç›®æ ‡ï¼ˆç›®æ ‡çš„åŸå‹ä¹Ÿæ˜¯ä»£ç†çš„åŸå‹ï¼‰ã€‚

```js
const PropertyChecker = new Proxy(
  {},
  {
    get(target, propKey, receiver) {
      if (!(propKey in target)) {
        throw new ReferenceError("Unknown property: " + propKey);
      }
      return Reflect.get(target, propKey, receiver);
    },
  }
);
```

è®©æˆ‘ä»¬ä½¿ç”¨`PropertyChecker`åˆ›å»ºçš„å¯¹è±¡ï¼š

```js
> const obj = { __proto__: PropertyChecker, foo: 123 };
> obj.foo  // è‡ªå·±çš„å±æ€§
123
> obj.fo
ReferenceError: Unknown property: fo
> obj.toString()  // ç»§æ‰¿çš„æ–¹æ³•
'[object Object]'
```

å¦‚æœæˆ‘ä»¬`PropertyChecker`ä½¿ç”¨æ„é€ å‡½æ•°ï¼Œåˆ™å¯ä»¥é€šè¿‡ extends ç»§æ‰¿ç±»

```js
function PropertyChecker() {}
PropertyChecker.prototype = new Proxy(
  {},
  {
    get(target, propKey, receiver) {
      if (!(propKey in target)) {
        throw new ReferenceError("Unknown property: " + propKey);
      }
      return Reflect.get(target, propKey, receiver);
    },
  }
);

class Point extends PropertyChecker {
  constructor(x, y) {
    super();
    this.x = x;
    this.y = y;
  }
}

const p = new Point(5, 7);
console.log(p.x); // 5
console.log(p.z); // ReferenceError
```

### è´Ÿæ•°ç»„ç´¢å¼•ï¼ˆgetï¼‰

æŸäº› Array æ–¹æ³•å¯è®©æ‚¨é€šè¿‡å¼•ç”¨-1 è·å¾—æœ€åä¸€ä¸ªå…ƒç´ ï¼Œä¾‹å¦‚ï¼š

```js
> ['a'ï¼Œ'b'ï¼Œ'c']ã€‚sliceï¼ˆ-1ï¼‰
['c']
```

é€šè¿‡æ–¹æ‹¬å·è¿ç®—ç¬¦ï¼ˆ`[]`ï¼‰è®¿é—®å…ƒç´ æ—¶ï¼Œè¯¥æ–¹æ³•ä¸èµ·ä½œç”¨ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»£ç†æ¥æ·»åŠ è¯¥åŠŸèƒ½ã€‚ä»¥ä¸‹å‡½æ•°`createArray()`åˆ›å»ºæ”¯æŒè´Ÿç´¢å¼•çš„æ•°ç»„ã€‚å®ƒé€šè¿‡å°†ä»£ç†åŒ…è£… Array å®ä¾‹æ¥å®ç°ã€‚

```js
function createArray(...elements) {
  const handler = {
    get(target, propKey, receiver) {
      const index = Number(propKey);
      if (index < 0) {
        propKey = String(target.length + index);
      }
      return Reflect.get(target, propKey, receiver);
    },
  };
  const target = [];
  target.push(...elements);
  return new Proxy(target, handler);
}
const arr = createArray("a", "b", "c");
console.log(arr[-1]); // c
```

### æ•°æ®ç»‘å®š

æ•°æ®ç»‘å®šæ˜¯å…³äºå¯¹è±¡ä¹‹é—´çš„æ•°æ®åŒæ­¥ã€‚æˆ–ç”¨äºä¸€ç§æµè¡Œçš„åŸºäº MVC æ¨¡å¼çš„åº“

å¸¸è§çš„æœ‰ vue,immer,mobx,...

è¦å®ç°æ•°æ®ç»‘å®šï¼Œæ‚¨å¿…é¡»è§‚å¯Ÿå¹¶å“åº”å¯¹å¯¹è±¡æ‰€åšçš„æ›´æ”¹ã€‚åœ¨ä¸‹é¢çš„ä»£ç ç‰‡æ®µä¸­ï¼Œæˆ‘æ¦‚è¿°äº†è§‚å¯Ÿæ›´æ”¹å¯¹æ•°ç»„çš„å·¥ä½œæ–¹å¼ã€‚

```js
function createObservedArray(callback) {
  const array = [];
  return new Proxy(array, {
    set(target, propertyKey, value, receiver) {
      callback(propertyKey, value);
      return Reflect.set(target, propertyKey, value, receiver);
    },
  });
}
const observedArray = createObservedArray((key, value) =>
  console.log(`${key}=${value}`)
);
observedArray.push("a");
```

### è®¿é—® RESTful æ¥å£æœåŠ¡

ä»£ç†å¯ç”¨äºåˆ›å»ºå¯ä»¥åœ¨å…¶ä¸Šè°ƒç”¨ä»»æ„æ–¹æ³•çš„å¯¹è±¡ã€‚åœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­ï¼Œè¯¥å‡½æ•°`createWebService`åˆ›å»ºä¸€ä¸ªè¿™æ ·çš„å¯¹è±¡`service`ã€‚è°ƒç”¨`service`æ–¹æ³•ï¼Œæ£€ç´¢å…·æœ‰ç›¸åŒåç§°çš„ Web æœåŠ¡èµ„æºçš„å†…å®¹ã€‚

```js

const service = createWebService('http://example.com/data');
// è¯»å–jsonæ•°æ® http://example.com/data/employees
service.employees().then(json => {
    const employees = JSON.parse(json);
    Â·Â·Â·
});
```

`createWebService` å®ç°

```js
function createWebService(baseUrl) {
  return new Proxy(
    {},
    {
      get(target, propKey, receiver) {
        return () => httpGet(baseUrl + "/" + propKey);
      },
    }
  );
}
```

`httpGet` å®ç°

```js
function httpGet(url) {
  return new Promise((resolve, reject) => {
    const request = new XMLHttpRequest();
    Object.assign(request, {
      onload() {
        if (this.status === 200) {
          resolve(this.response);
        } else {
          reject(new Error(this.statusText));
        }
      },
      onerror() {
        reject(new Error("XMLHttpRequest Error: " + this.statusText));
      },
    });
    request.open("GET", url);
    request.send();
  });
}
```

- å¦ä¸€ç§å®ç°

```js
const { METHODS } = require("http");
const api = new Proxy(
  {},
  {
    get(target, propKey) {
      const method = METHODS.find((method) =>
        propKey.startsWith(method.toLowerCase())
      );
      if (!method) return;
      const path =
        "/" +
        propKey
          .substring(method.length)
          .replace(/([a-z])([A-Z])/g, "$1/$2")
          .replace(/\$/g, "/$/")
          .toLowerCase();
      return (...args) => {
        const finalPath = path.replace(/\$/g, () => args.shift());
        const queryOrBody = args.shift() || {};
        console.log(method, finalPath, queryOrBody);
        return fetch(finalPath, { method, body: queryOrBody });
      };
    },
  }
);
// GET /
api.get();
// GET /users
api.getUsers();
// GET /users/1234/likes
api.getUsers$Likes("1234");
// GET /users/1234/likes?page=2
api.getUsers$Likes("1234", { page: 2 });
// POST /items with body
api.postItems({ name: "Item name" });
// api.foobar is not a function
api.foobar();
```

- å†æ¥ä¸€ç§

```js
let handlers = {
  get(target, property) {
    if (!target.init) {
      // åˆå§‹åŒ–å¯¹è±¡
      ["GET", "POST"].forEach((method) => {
        target[method] = (url, params = {}) => {
          return fetch(url, {
            headers: {
              "content-type": "application/json",
            },
            mode: "cors",
            credentials: "same-origin",
            method,
            ...params,
          }).then((response) => response.json());
        };
      });
    }

    return target[property];
  },
};
let API = new Proxy({}, handlers);

await API.GET("XXX");
await API.POST("XXX", {
  body: JSON.stringify({ name: 1 }),
});
```

- æœ‰è¶£çš„æ–¹å¼

```js
const www = new Proxy(new URL("https://www"), {
  get: function get(target, prop) {
    let o = Reflect.get(target, prop);
    console.log("ğŸš€ ~ file: 2021-2-23-proxy.md ~ line 21 ~ get ~ o", o, prop);
    if (typeof o === "function") {
      return o.bind(target);
    }
    if (typeof prop !== "string") {
      return o;
    }
    if (prop === "then") {
      return Promise.prototype.then.bind(fetch(target));
    }
    target = new URL(target);
    target.hostname += `.${prop}`;
    console.log("get", get);
    return new Proxy(target, { get });
  },
});

// è®¿é—®ç™¾åº¦
www.baidu.com.then((response) => {
  console.log(response.status);
  // ==> 200
});

// ä½¿ç”¨ async/await è¯­æ³•ï¼š
(async () => {
  const response = (await www.baidu.com) + "foo/1111";

  console.log(response.ok);
  // ==> true

  console.log(response.status);
  // ==> 200
})();
```

### æ’¤é”€å¼•ç”¨

å¯æ’¤é”€å¼•ç”¨çš„å·¥ä½œæ–¹å¼å¦‚ä¸‹ï¼š
ä¸å…è®¸ç”¨æˆ·ç›´æ¥è®¿é—®å¯¹è±¡å±æ€§ï¼ˆæˆ–è€…è½¬å‘ä½ çš„æœåŠ¡å™¨èµ„æºï¼‰ï¼Œç”¨æˆ·å®Œæˆå¼•ç”¨åï¼Œé€šè¿‡æ’¤æ¶ˆå¼•ç”¨ï¼ˆå°†å…¶å…³é—­ï¼‰æ¥ä¿æŠ¤èµ„æºã€‚æ­¤åï¼Œå†å¼•ç”¨å°†å¼•å‘å¼‚å¸¸ï¼Œå¹¶ä¸”ä¸å†è½¬å‘ä»»ä½•å†…å®¹ã€‚

```js
const resource = { x: 11, y: 8 };
const { reference, revoke } = createRevocableReference(resource);

// å¼•ç”¨æˆæƒ
console.log(reference.x); // 11
// æ’¤é”€
revoke();

console.log(reference.x); // TypeError: Revoked
```

ä»£ç†éå¸¸é€‚åˆå®ç°å¯æ’¤é”€å¼•ç”¨ï¼Œå› ä¸ºå®ƒä»¬å¯ä»¥æ‹¦æˆªå’Œè½¬å‘æ“ä½œã€‚è¿™æ˜¯åŸºäºä»£ç†çš„ç®€å•å®ç°`createRevocableReference`ï¼š

```js
function createRevocableReference(target) {
    let enabled = true;
    return {
        reference: new Proxy(target, {
            get(target, propKey, receiver) {
                if (!enabled) {
                    throw new TypeError('Revoked');
                }
                return Reflect.get(target, propKey, receiver);
            },
            has(target, propKey) {
                if (!enabled) {
                    throw new TypeError('Revoked');
                }
                return Reflect.has(target, propKey);
            },
            Â·Â·Â·
        }),
        revoke() {
            enabled = false;
        },
    };
}
```

ç®€åŒ–

```js
function createRevocableReference(target) {
  let enabled = true;
  const handler = new Proxy(
    {},
    {
      get(dummyTarget, trapName, receiver) {
        if (!enabled) {
          throw new TypeError("Revoked");
        }
        return Reflect[trapName];
      },
    }
  );
  return {
    reference: new Proxy(target, handler),
    revoke() {
      enabled = false;
    },
  };
}
```

ä¸è¿‡æˆ‘ä»¬ä¸å¿…è‡ªå·±å®ç°æ’¤é”€ï¼Œå› ä¸º `proxy` è‡ªå¸¦æ”¹æ–¹æ³•

```js
function createRevocableReference(target) {
  const handler = {}; // {} å°±ä¼šè½¬å‘æ‰€æœ‰
  const { proxy, revoke } = Proxy.revocable(target, handler);
  return { reference: proxy, revoke };
}
```

### åˆ›å»ºç±»å‹æ£€æŸ¥

é˜²æ­¢ç”¨æˆ·è¾“å…¥ä¸åˆæ³•

```js
var person = {
  name: "Artiely",
};

var typeSafePerson = createTypeSafeObject(person);

typeSafePerson.name = "Mike"; // ok
typeSafePerson.age = 18; // ok
typeSafePerson.age = "red"; // throws an error, different types
```

åªéœ€ç®€å•çš„åˆ¤æ–­å½“å‰èµ‹å€¼çš„ç±»å‹æ˜¯å¦ç­‰äºä¸Šæ¬¡çš„ç±»å‹

```js
function createTypeSafeObject(object) {
  return new Proxy(object, {
    set: function(target, property, value) {
      var currentType = typeof target[property],
        newType = typeof value;

      if (property in target && currentType !== newType) {
        throw new Error(
          "Property " + property + " must be a " + currentType + "."
        );
      } else {
        target[property] = value;
      }
    },
  });
}
```

### å­—æ®µæ ¡éªŒ

```js
let p = validator({});
p.age = 18;
p.age = "young"; // throws an error
p.age = 200; // throws an error
```

```js
const validator = (target) => {
  return new Proxy((target = {}), {
    set(target, props, value) {
      if (props === "age") {
        if (!Number.isInteger(value) || value > 200 || value < 0) {
          throw new TypeError("age should be an integer between 0 and 150");
        }
        target[props] = value;
        return true;
      }
    },
  });
};
```

### çº§è”å±æ€§

æ•°æ®å¯¹åº”å…³ç³»

```js
JavaScript Street  --  232200
Python Street -- 234422
Golang Street -- 231142

```

ä¸¤ç»„æ˜ å°„å…³ç³»è¡¨

```js
const location2postcode = {
  "JavaScript Street": 232200,
  "Python Street": 234422,
  "Golang Street": 231142,
};
const postcode2location = {
  "232200": "JavaScript Street",
  "234422": "Python Street",
  "231142": "Golang Street",
};
```

ä½¿ç”¨ç¤ºä¾‹

```js
let person = {
  name: 'Jon'
}
let p = postcodeValidate(person)
p.postcode = 232200
p.location
>JavaScript Street
```

å®ç°

```js
const postcodeValidate = (obj) => {
  return new Proxy(obj, {
    set(item, property, value) {
      if (property === "location") {
        item.postcode = location2postcode[value];
      }
      if (property === "postcode") {
        item.location = postcode2location[value];
      }
    },
  });
};
```

### ç§æœ‰åŒ–å±æ€§

ä½¿å¸¦æœ‰`_`çš„å±æ€§ç§æœ‰åŒ–ï¼Œå¤–ç•Œä¸å¯è®¿é—®,å¦‚ä¸‹

```js
let obj = {
  name: "artiely",
  _age: 18,
};
let objProxy = setPrivateField(obj);

obj._age; //undefined
_age in objProxy; // false
```

```js
function setPrivateField(obj, prefix = "_") {
  return new Proxy(obj, {
    has: (obj, prop) => {
      if (typeof prop === "string" && prop.startsWith(prefix)) {
        return false;
      }
      return prop in obj;
    },
    ownKeys: (obj) => {
      return Reflect.ownKeys(obj).filter(
        (prop) => typeof prop !== "string" || !prop.startsWith(prefix)
      );
    },
    get: (obj, prop) => {
      if (typeof prop === "string" && prop.startsWith(prefix)) {
        return undefined;
      }
      return obj[prop];
    },
  });
}
```

### æ—¥å¿—æ‰“å°

### ä»£ç†å±æ€§æŸ¥æ‰¾

èµ·å› 

```js
const obj = {
  name: "artiely",
};
console.log(obj.age);
// undefined
```

```js
let handler = {
  get: function(target, props) {
    return props in target ? target[props] : "æœªè®¾ç½®å€¼";
  },
};

let obj = {
  name: "artiely",
};

let p = new Proxy(obj, handler);

console.log(p.age); // æœªè®¾ç½®çš„å€¼
```

### ç›‘å¬æ¯ä¸ªå¼‚æ­¥çš„è¿‡ç¨‹

```js
const logUpdate = require("log-update");
const asciichart = require("asciichart");
const chalk = require("chalk");
const Measured = require("measured");
const timer = new Measured.Timer();
const history = new Array(120);
history.fill(0);
const monitor = (obj) => {
  return new Proxy(obj, {
    get(target, propKey) {
      const origMethod = target[propKey];
      if (!origMethod) return;
      return (...args) => {
        const stopwatch = timer.start();
        const result = origMethod.apply(this, args);
        return result.then((out) => {
          const n = stopwatch.end();
          history.shift();
          history.push(n);
          return out;
        });
      };
    },
  });
};
const service = {
  callService() {
    return new Promise((resolve) =>
      setTimeout(resolve, Math.random() * 50 + 50)
    );
  },
};
const monitoredService = monitor(service);
setInterval(() => {
  monitoredService
    .callService()
    .then(() => {
      const fields = [
        "min",
        "max",
        "sum",
        "variance",
        "mean",
        "count",
        "median",
      ];
      const histogram = timer.toJSON().histogram;
      const lines = [
        "",
        ...fields.map(
          (field) =>
            chalk.cyan(field) + ": " + (histogram[field] || 0).toFixed(2)
        ),
      ];
      logUpdate(asciichart.plot(history, { height: 10 }) + lines.join("\n"));
    })
    .catch((err) => console.error(err));
}, 100);
```

### ç¼“å­˜

```js
const cacheTarget = (target, ttl = 60) => {
  const CREATED_AT = Date.now();
  const isExpired = () => Date.now() - CREATED_AT > ttl * 1000;
  const handler = {
    get: (target, prop) => (isExpired() ? undefined : target[prop]),
  };
  return new Proxy(target, handler);
};

const cache = cacheTarget({ age: 25 }, 5);

console.log(cache.age);

setTimeout(() => {
  console.log(cache.age);
}, 6 * 1000);
//è¿è¡Œç»“æœå¦‚ä¸‹:
25;
undefined;
```

### è®¡ç®—å±æ€§

```js
const bankAccount = {
  balance: 10,
  name: "Artiely",
  get dollars() {
    console.log("è®¡ç®—ç¾å…ƒ");
    return this.balance * 0.1547
  },
};

let cache = {
  currentBalance: null,
  currentValue: null,
};

const handler = {
  get: function(obj, prop) {
    if (prop === "dollars") {
      let value =
        cache.currentBalance !== obj.balance ? obj[prop] : cache.currentValue;

      cache.currentValue = value;
      cache.currentBalance = obj.balance;

      return value;
    }

    return obj[prop];
  },
};

const wrappedBankAcount = new Proxy(bankAccount, handler);

console.log(wrappedBankAcount.dollars);
console.log(wrappedBankAcount.dollars);
console.log(wrappedBankAcount.dollars);
console.log(wrappedBankAcount.dollars);

// OUTPUT:
// è®¡ç®—ç¾å…ƒ
// 34.3008459
// 34.3008459
// 34.3008459
// 34.3008459
```
